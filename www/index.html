<!DOCTYPE html>
<html>
    <head>
        <title>Gearculator - gear ratio calculator</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
		<link rel="stylesheet" type="text/css" href="css/index.css" />
        <link rel="stylesheet" href="css/jquery.mobile-1.2.0.min.css" />
        <script src="js/jquery-1.8.2.min.js"></script>
		<script src="js/jquery.mobile-1.2.0.min.js"></script>
		<script type="text/javascript" src="cordova-2.0.0.js"></script>
		<script type="text/javascript">
			/*
			 * Returns the  greatest common divisor (GCD) of the given integers. Each input must be non-negative.
			 */
			function gcd(x, y) {
				while (y != 0) {
					var z = x % y;
					x = y;
					y = z;
				}
				return x;
			}
		       
			var DrawUtil = function() {};

			DrawUtil.prototype.drawWheel = function (context) {
				var centerX = display.maxWheelWidthPx / 2;
				var centerY = display.maxWheelWidthPx / 2;
				var lineWidth = 45 * display.pxPerMM;
				var radius = inputs.wheelSize * display.pxPerMM / 2 - lineWidth; 

				context.clearRect(0, 0, display.maxWheelWidthPx, display.maxWheelWidthPx);
				context.beginPath();
				context.arc(centerX, centerY, radius, 0, 2 * Math.PI, false);
				context.strokeStyle = "#FA20EA";
				context.lineWidth = 45 * display.pxPerMM;
				context.stroke();
				
			};
			
			DrawUtil.prototype.drawSkid = function (context, numSkids) {
				var centerX = display.maxWheelWidthPx / 2;
				var centerY = display.maxWheelWidthPx / 2;
				var lineWidth = 15 * display.pxPerMM;
				var radius = inputs.wheelSize * display.pxPerMM / 2 - (lineWidth * 2); 
				
				context.clearRect(0, 0, display.maxWheelWidthPx, display.maxWheelWidthPx);
				
				for (var i = 0; i < numSkids; i++) {
					context.beginPath();
					var pos = i *  360 / numSkids; 
					context.strokeStyle = "#76006d";
					context.lineWidth = lineWidth;
					context.arc(centerX, centerY, radius, pos/360 * 2 * Math.PI, (pos + 3)/ 360 * 2 * Math.PI , false);
					//context.closePath();
					context.stroke();
				}
				
				
			};
			
			DrawUtil.prototype.drawChainRing = function (context, numT, clearCanvas) {
				// http://www.scienceprimer.com/drawing-regular-polygons-javascript-canvas
				// http://html5example.net/entry/html5-canvas/html5-canvas-gears
				var centerX = display.maxWheelWidthPx / 2;
				var centerY = display.maxWheelWidthPx / 2;
				var lineWidth = (6 * display.pxPerMM);
				var teethlength = (12 * display.pxPerMM);
				var radiusMM = 12.5 / ( 2 * Math.sin( Math.PI / numT ) );
				var radiusPx = radiusMM * display.pxPerMM - lineWidth;
				var sizePx = radiusPx * 2;
				var teethRaiusPx = radiusPx + teethlength;
				
				context.clearRect(0, 0, display.maxWheelWidthPx, display.maxWheelWidthPx);
				context.beginPath();
				//context.moveTo (centerY +  sizePx * Math.cos(0), centerY +  sizePx *  Math.sin(0));
				context.arc(centerX, centerY, radiusPx, 0, 2 * Math.PI, false);
				//context.fillStyle = "#000000";
				//context.fill();
				context.lineWidth = lineWidth;
				
				for (i = 0; i < numT; i++) {
					context.moveTo (centerY +  radiusPx * Math.cos(i * 2 * Math.PI / numT), centerY +  radiusPx *  Math.sin(i * 2 * Math.PI / numT));
					context.lineTo (centerX + teethRaiusPx * Math.cos(i * 2 * Math.PI / numT), centerY + teethRaiusPx * Math.sin(i * 2 * Math.PI / numT));
				}
				
				context.strokeStyle = "#05F017";
				context.stroke();
				
			};
			
			function updateStats(inputs) {
				inputs.wheelSize = jqObj.wheelSize.val();
				inputs.fCog  =jqObj.fCog.val();
				inputs.bCog  = jqObj.bCog.val();
				inputs.cadence  = jqObj.cadence.val();

				var ratio = inputs.fCog / inputs.bCog;
				var ratioGCD = gcd(inputs.fCog, inputs.bCog);
				inputs.skidPatches = inputs.bCog / ratioGCD;
				inputs.ambidextrousSkidPatches = inputs.skidPatches;
				if ( inputs.fCog % 2 == 0) inputs.ambidextrousSkidPatches = inputs.skidPatches * 2;
				var kph = ratio * inputs.wheelSize * Math.PI * inputs.cadence * 60 / 1000000;
				var mph = kph * 0.621371;
				
				jqObj.ratio.html(ratio.toFixed(2));
				jqObj.kph.html(kph.toFixed(2));
				jqObj.mph.html(mph.toFixed(2));
				
				jqObj.skidPatches.html(inputs.skidPatches);
				jqObj.ambidextrousSkidPatches.html(inputs.ambidextrousSkidPatches);
			}
			
			var drawUtil = new DrawUtil();
			
			var constants = {};
			constants.maxWheelWidthMM = 914.4;
			
			var inputs = {};	
			var display = {};
			var el = {};
			var jqObj = {};
			var context = {};
			var timeout = {};
			
			function displaySetUp() {
				display.windowW = $(window).width();
				display.maxWheelWidthPx = Math.floor(display.windowW / 2);
				if ($(window).height() / 2 < display.maxWheelWidthPx) display.maxWheelWidthPx = $(window).height() / 2;
				
				display.numDispFontSize = display.maxWheelWidthPx / 9;
				display.pxPerMM = display.maxWheelWidthPx / constants.maxWheelWidthMM;
			
				var $cContainer = $("#canvas-container");
				$cContainer.height(display.maxWheelWidthPx);

				el.backRing.width = display.maxWheelWidthPx;
				el.backRing.height = display.maxWheelWidthPx;
				el.backRing.style.left = $cContainer.offset().left + 'px';
				el.backRing.style.top = $cContainer.offset().top + 'px';
				
				el.backWheel.width = display.maxWheelWidthPx;
				el.backWheel.height = display.maxWheelWidthPx;
				el.backWheel.style.left =  $cContainer.offset().left + 'px';
				el.backWheel.style.top =  $cContainer.offset().top + 'px';
				
				el.skid.width = display.maxWheelWidthPx;
				el.skid.height = display.maxWheelWidthPx;
				el.skid.style.left =  $cContainer.offset().left + 'px';
				el.skid.style.top =  $cContainer.offset().top + 'px';
				
				el.frontRing.width = display.maxWheelWidthPx;
				el.frontRing.height = display.maxWheelWidthPx;
				el.frontRing.style.left =  $cContainer.offset().left + display.maxWheelWidthPx * 9 / 16 + 'px';
				el.frontRing.style.top =  $cContainer.offset().top +  ( display.maxWheelWidthPx * 0.05) + 'px';

				$('#num-disp').css("font-size", display.numDispFontSize +'px');

			}
						
			function changeWheelButtonTxt() {
				$('#wheel-size-page-button-txt').html('Tire Diam.: ' + $('#wheel-size').val() + ' mm');
			}
			
			function changeCadenceButtonTxt() {
				$('#cadence-page-button-txt').html('Cadence: ' + $('#cadence').val() + ' rpm');
			}
			
			function initAll() {
				el.backWheel = document.getElementById("back-wheel-canvas");
				el.skid = document.getElementById("skid-canvas");	
				el.backRing = document.getElementById("back-ring-canvas");
				el.frontRing = document.getElementById("front-ring-canvas");
				
				jqObj.wheelSize = $('#wheel-size');
				jqObj.fCog = $('#f-cog');
				jqObj.bCog = $('#b-cog');
				jqObj.cadence = $('#cadence');
				jqObj.ratio = $("#ratio");
				jqObj.kph = $("#kph");
				jqObj.mph = $("#mph");
				jqObj.skidPatches = $("#skid-patches");
				jqObj.ambidextrousSkidPatches = $("#ambidextrous-skid-patches");
				
				context.backWheel = el.backWheel.getContext("2d");
				context.skid = el.skid.getContext("2d");
				context.backRing = el.backRing.getContext("2d");
				context.frontRing = el.frontRing.getContext("2d");
	
				displaySetUp();	
				updateStats(inputs);
				drawUtil.drawWheel(context.backWheel);
				drawUtil.drawChainRing(context.backRing,inputs.bCog);
				drawUtil.drawChainRing(context.frontRing, inputs.fCog);
				drawUtil.drawSkid(context.skid, inputs.ambidextrousSkidPatches);
				changeWheelButtonTxt();
				changeCadenceButtonTxt();
			}
			
			//JQ on ready
			$(function () {
				initAll();
			/*	if (window.cordova) {
					document.addEventListener("deviceready", initAll, false);
				} else {
					initAll();
				}
			*/
			});
			
			$(document).live('pageinit', function(event, ui) {
				$('#f-cog').live('change', function(event, ui){
					updateStats(inputs);
					setTimeout(function() { 
						drawUtil.drawChainRing(context.frontRing, inputs.fCog);
						drawUtil.drawSkid(context.skid, inputs.ambidextrousSkidPatches);
					}, 50);
				});
				$('#b-cog').live('change', function(event, ui){
					updateStats(inputs);
					setTimeout(function() { 
						drawUtil.drawChainRing(context.backRing,inputs.bCog, false);
						drawUtil.drawSkid(context.skid, inputs.ambidextrousSkidPatches);
					}, 50);
				});
				$('#cadence').live('change', function(event, ui){
					updateStats(inputs);
				});
				$('#wheel-size').live('change', function(event, ui){
					updateStats(inputs);
					setTimeout(function() { 
						drawUtil.drawWheel(context.backWheel);
						drawUtil.drawSkid(context.skid, inputs.ambidextrousSkidPatches);
					}, 50);
					changeWheelButtonTxt();
				});
				$('#cadence').live('change', function(event, ui){
					updateStats(inputs);
					changeCadenceButtonTxt();
				});			
				
				// tireSize: inch , description
				var tireSizes = [
					[ 29, '29 inch (nominal)'],
					[ 28, '	28 inch (nominal)'],
					[ 27, '	27 inch (nominal)'],
					[ 26, '	26 inch (nominal)'],
					[ 29.13, '	700 X 56 / 56-622 / 29 inch'],
					[ 28.94, '	700 X 50 / 50-622 / 29 inch'],
					[ 27.86, '	700 X 44 / 44-622 / 29 inch'],
					[ 27.32, '	700 X 38 / 38-622'],
					[ 27.17, '	700 X 35 / 35-622'],
					[ 27, '	700 X 32 / 32-622'],
					[ 26.76, '	700 X 28 / 28-622'],
					[ 26.38, '	700 X 25 / 25-622'],
					[ 26.28, '	700 X 23 / 23-622'],
					[ 26.14, '	700 X 20 / 20-622'],
					[ 26.53, '	Tubular / Wide'],
					[ 26.38, '	Tubular / Narrow'],
					[ 28.15, '	28 X 1 1/2 / 40-635'],
					[ 27.18, '	27 X 1 3/8 / 35-630'],
					[ 27.08, '	27 X 1 1/4 / 32-630'],
					[ 27, '	27 X 1 1/8 / 28-630'],
					[ 26.88, '	27 X 1 / 25-630'],
					[ 26.41, '	26 X 2.35 / 60-559 / MTB'],
					[ 25.94, '	26 X 2.125 / 54-559 / MTB'],
					[ 25.75, '	26 X 1.9 / 47-559 / MTB'],
					[ 24.87, '	26 X 1.5 / 38-559 / MTB'],
					[ 24.47, '	26 X 1.25 / 32-559 / MTB'],
					[ 23.97, '	26 X 1.0 / 25-559 / MTB'],
					[ 26, '	650 x 38b / 38-584 650B'],
					[ 24.7, '	650 x 28C / 28-571 / 26" road/tri'],
					[ 24.46, '	650 x 25C / 25-571 / 26" road/tri'],
					[ 24.31, '	650 x 23C / 23-571 / 26" road/tri'],
					[ 25.91, '	26 X 1 3/8 / 35-590'],
					[ 24, '	24 inch (nominal)'],
					[ 21.97, '	24 x 1 / 25-520'],
					[ 20.15, '	32-451 /20 x 1 3/8'],
					[ 19.9, '	28-451/20 x 1 1/8'],
					[ 18.68, '	20 X 1.75 / 44-406 / BMX'],
					[ 18.43, '	20 X 1.25 / 32-406'],
					[ 17.16, '	18 x 1.5 / 40-355'],
					[ 16.6, '	17 x 1 1/4 / 28-369'],
					[ 16.88, '	16 x 1 1/2 / 40-349'],
					[ 16.07, '	16 x 1 3/8 / 35-349'],
					[ 13.46, '	16 x 1.5 / 37-305']
				];
				
				var tireSizesOutput = "";
				for (i=0; i< tireSizes.length; i++) {
					tireSizesOutput = tireSizesOutput 
					+ "<tr>"
					+ "   <td style='vertical-align: middle; font-weight: bold;'>" + tireSizes[i][1] + "&nbsp; </td>"
					+ "   <td style='vertical-align: middle;'>" + tireSizes[i][0].toFixed(2) + " in&nbsp; </td>"
					+ "   <td style='vertical-align: middle;'>" + Math.round(tireSizes[i][0] * 25.4) + " mm&nbsp; </td>"
					+ "   <td style='vertical-align: middle; '><a href='' id='tireSizeButton" + i + "' style='color: white;' data-mini='true' >Select </a></td>"
					+ "</tr>"
				}
				$('#wheel-size-table').html(tireSizesOutput);
				for (i=0; i< tireSizes.length; i++) {
					$("#tireSizeButton" + i).button();
					(function(size) {
						$("#tireSizeButton" + i).bind('click', function() {
							jqObj.wheelSize.val(size);
							jqObj.wheelSize.slider('refresh');
							return false;
						});
					})(Math.round(tireSizes[i][0] * 25.4));
				}
				
			});
			
			
		</script>
	</head>
    <body>
		<div id="index-page" data-role="page" data-theme="a">
			<div data-role="header"> 
				<h1>Gearculator</h1>
				<a href="#about-page" data-role="button" data-transition="flip">About</a>							
			</div> 
			<div data-role="content" style="padding-top: 0px;">	
				<div id="canvas-container">
					<div style="width: 35%; height: 100%; float: right; display: table;">
						<div id="num-disp"  style="display: table-cell; vertical-align: middle; font-weight: bold;">
							RATIO
							<span id="ratio">&nbsp;</span><br />
							<br />
							MPH
							<span id="mph">&nbsp;</span><br />
							<br />
							KPH	
							<span id="kph">&nbsp;</span><br />
						</div>
					</div>
					<canvas width="100" height="100" id="back-wheel-canvas" style="position: absolute;" ></canvas>
					<canvas width="100" height="100" id="skid-canvas" style="position: absolute;" ></canvas>
					<canvas width="100" height="100" id="back-ring-canvas" style="position: absolute;" ></canvas>
					<canvas width="100" height="100" id="front-ring-canvas" style="position: absolute;"></canvas>
				</div>
				<div style="clear: both;"></div>
				Skid Patches <span id="skid-patches"></span><br />
				Ambidextrous Skid Patches <span id="ambidextrous-skid-patches"></span>
				<div data-role="fieldcontain">
				<label for="b-cog">Back Cog (Teeth)</label>
				<input type="range" name="b-cog" id="b-cog" value="16" min="10" max="34" />
				</div>
				<div data-role="fieldcontain">
				<label for="f-cog">Front Cog (Teeth)</label>
				<input type="range" name="f-cog" id="f-cog" value="46" min="20" max="52" />
				</div>
				<a href="#cadence-page" id=="cadence-page-button" data-role="button" data-transition="flip"><span id='cadence-page-button-txt'></span></a>
				<a href="#wheel-size-page" id=="wheel-size-page-button" data-role="button" data-transition="flip"><span id='wheel-size-page-button-txt'></span></a>				
			</div>
		</div>
		<div id="wheel-size-page" data-role="page" data-theme="a">
			<div data-role="header">
				<h1>Wheel Size</h1>
				<a href="#index-page" data-role="botton" data-transition="flip">Back</a>
			</div>
			<div data-role="content">	
				<div data-role="fieldcontain">
					<label for="wheel-size"">Wheel Size (Millimeter)</label>
					<input type="range" name="wheel-size" id="wheel-size" value="679" min="406" max="914" />
				</div>		
				<p>This is the diameter of wheel measured top to bottm. Below are estimates of common sizes.</p>
				<table id="wheel-size-table" width="100%">
				</table>
			</div>
		</div>
		<div id="cadence-page" data-role="page" data-theme="a">
			<div data-role="header">
				<h1>Cadence</h1>
				<a href="#index-page" data-role="botton" data-transition="flip">Back</a>
			</div>
			<div data-role="content">	
				<p>Cadence is how many times the pedals rotate around per a mintue.</p>
				<div data-role="fieldcontain">
					<label for="cadence">Cadence</label>
					<input type="range" name="cadence" id="cadence" value="90" min="10" max="140" />
				</div>
			</div>
		</div>
		<div id="about-page" data-role="page" data-theme="a">
			<div data-role="header">
				<h1>About Gearculator</h1>
				<a href="#index-page" data-role="botton" data-transition="flip">Back</a>
			</div>
			<div data-role="content">	
				<p>blah blah blah, donate:, blah blah blah Sheldon Brown rocks blah blah b</p>		
			</div>
		</div>
    </body>
</html>
